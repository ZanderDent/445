<!-- templates/budget.html -->
{% extends "base.html" %}
{% block title %}Budget — Cable-Stayed Option{% endblock %}

{% block extra_head %}
<style>
  .budget-page .header{
    margin:1rem 0 1.25rem; padding:1rem;
    background:var(--panel); border:var(--line); border-radius:var(--radius);
  }
  .budget-page .muted{ color:var(--muted); }

  /* Summary cards */
  .budget-page .summary{
    display:grid; grid-template-columns:repeat(4,minmax(0,1fr));
    gap:.75rem; margin-bottom:1rem;
  }
  .budget-card{
    background:var(--bg-soft); border:var(--line); border-radius:12px;
    padding:.9rem; box-shadow:var(--shadow);
  }
  .budget-card h3{ margin:0 0 .35rem; font-size:.95rem; color:var(--muted); font-weight:600; }
  .budget-card .value{ font-size:1.15rem; font-weight:700; letter-spacing:.2px; }

  /* Sections & tables */
  .box{ background:var(--bg-soft); border:var(--line); border-radius:14px; padding:1rem; color:var(--text); margin-bottom:1rem; }
  .table-wrap{ width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:10px; }
  table{ width:100%; border-collapse:collapse; }
  th,td{ border:var(--line); padding:.6rem .7rem; vertical-align:top; }
  th{ background:#162033; color:var(--text); text-align:left; }
  .num, .money{ text-align:right; white-space:nowrap; }
  .w-240{ min-width:240px; }
  .w-220{ min-width:220px; }

  /* Left-align the Team Hours cells */
  td.hours { text-align:left !important; white-space:nowrap; }

  .budget-note{
    background:#0b1220; border:var(--line); border-left:4px solid var(--accent);
    border-radius:10px; padding:.8rem 1rem; color:var(--text);
  }

  /* Simple progress bar for “share of $5M” */
  .share-bar{ display:flex; height:10px; background:#0b1220; border:var(--line); border-radius:999px; overflow:hidden; }
  .share-fill{ background:linear-gradient(90deg,#00d1b2,#22c55e); width:0%; }

  /* Mobile */
  @media (max-width:980px){ .budget-page .summary{ grid-template-columns:1fr 1fr; } }
  @media (max-width:640px){
    .budget-page .summary{ grid-template-columns:1fr; }
    th,td{ white-space:normal; }
  }
</style>
{% endblock %}

{% block content %}
<section class="budget-page">
  <div class="header">
    <h1 style="margin:0 0 .25rem;">Team 7 — Design Budget</h1>
    <div class="muted">Phase-based estimate aligned to a ~$5M project. Values include fees, disbursements, subs, and taxes.</div>
  </div>

  <!-- Summary (auto-filled by script) -->
  <div class="summary">
    <div class="budget-card">
      <h3>Conceptual (sum)</h3>
      <div id="card-conceptual" class="value">—</div>
    </div>
    <div class="budget-card">
      <h3>Preliminary (sum)</h3>
      <div id="card-prelim" class="value">—</div>
    </div>
    <div class="budget-card">
      <h3>Detailed (sum)</h3>
      <div id="card-detailed" class="value">—</div>
    </div>
    <div class="budget-card">
      <h3>Grand Total (design)</h3>
      <div id="card-grand" class="value">—</div>
      <div class="share-bar" style="margin-top:.5rem;"><div id="share-fill" class="share-fill"></div></div>
      <small class="muted"><span id="share-pct">—</span> of $5,000,000</small>
    </div>
  </div>

  <!-- Phase Breakdown (authoritative rows; script computes totals) -->
  <div class="box">
    <h2>Phase Breakdown</h2>
    <div class="table-wrap">
      <table id="phase-table">
        <thead>
          <tr>
            <th>Cost Metric</th>
            <th class="num">Conceptual Design</th>
            <th class="num">Preliminary Design</th>
            <th class="num">Detailed Design</th>
            <th class="num">Sum</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Team Hours</td>
            <td class="hours">117</td>
            <td class="hours">195</td>
            <td class="hours">468</td>
            <td class="hours">780</td>
          </tr>

          <tr data-row>
            <td>Team Total Costs</td>
            <td data-v="26770.50"></td>
            <td data-v="44617.50"></td>
            <td data-v="107082.00"></td>
            <td class="row-sum"></td>
          </tr>
          <tr data-row>
            <td>Normal Disbursements</td>
            <td data-v="2141.64"></td>
            <td data-v="3569.40"></td>
            <td data-v="8566.56"></td>
            <td class="row-sum"></td>
          </tr>
          <tr data-row>
            <td>Project-Specific Disbursements</td>
            <td data-v="7700.00"></td>
            <td data-v="23100.00"></td>
            <td data-v="46200.00"></td>
            <td class="row-sum"></td>
          </tr>
          <tr data-row>
            <td>Sub-consultants</td>
            <td data-v="12600.00"></td>
            <td data-v="50400.00"></td>
            <td data-v="63000.00"></td>
            <td class="row-sum"></td>
          </tr>
          <tr data-row>
            <td>Subcontractors</td>
            <td data-v="3300.00"></td>
            <td data-v="23100.00"></td>
            <td data-v="39600.00"></td>
            <td class="row-sum"></td>
          </tr>
          <tr data-row>
            <td>GST</td>
            <td data-v="2625.61"></td>
            <td data-v="7239.35"></td>
            <td data-v="13222.43"></td>
            <td class="row-sum"></td>
          </tr>
          <tr data-row>
            <td>PST</td>
            <td data-v="1000.00"></td>
            <td data-v="3000.00"></td>
            <td data-v="6000.00"></td>
            <td class="row-sum"></td>
          </tr>

          <tr>
            <th>Phase Totals</th>
            <th id="sum-conceptual" class="money">—</th>
            <th id="sum-prelim"     class="money">—</th>
            <th id="sum-detailed"   class="money">—</th>
            <th id="sum-grand"      class="money">—</th>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="budget-note" style="margin-top:.75rem;">
      Conceptual covers option screening and early coordination; Preliminary advances the preferred concept to feasibility; Detailed concentrates production, coordination with subs, permitting support, and tender documentation.
    </div>
  </div>

  <!-- Construction Cost Model (unit-rate → premiums → contingency) -->
  <div class="box">
    <h2>Construction Cost Model — Cable-Stayed (Concept)</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Bridge Type</th>
            <th class="num">Span (m)</th>
            <th class="num">Deck Width (m)</th>
            <th class="num">Deck Area (m²)</th>
            <th class="num">Base Unit Cost ($/m²)</th>
            <th class="num">Remote Factor</th>
            <th class="num">Contingency</th>
            <th class="money">Total Cost (CAD)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Cable-Stayed</td>
            <td class="num">125</td>
            <td class="num">4</td>
            <td class="num">500</td>
            <td class="num">$9,900</td>
            <td class="num">+15%</td>
            <td class="num">+10%</td>
            <td class="money">$6,261,750.00</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="budget-note">
      Computation check: 500&nbsp;m² × $9,900 = $4,950,000; +15% remote = $5,692,500; +10% contingency = <strong>$6,261,750</strong>.
    </div>
  </div>

  <!-- Project Cost Roll-up (incl. design & taxes) -->
  <div class="box">
    <h2>Total Project Roll-up — Cable-Stayed</h2>
    <div class="table-wrap" style="margin-bottom:.75rem;">
      <table>
        <thead>
          <tr>
            <th>Metric</th>
            <th class="money">Amount (CAD)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Estimated Construction Cost</td><td class="money">$4,641,252.02</td></tr>
          <tr><td>Remote Site Premium (15%)</td><td class="money">$696,187.80</td></tr>
          <tr><td>Construction Contingency (10%)</td><td class="money">$464,125.20</td></tr>
          <tr><td>Total Design Fees</td><td class="money">$428,747.60</td></tr>
          <tr><td>Estimated GST</td><td class="money">$311,515.63</td></tr>
          <tr><td>Estimated PST</td><td class="money">$184,046.95</td></tr>
          <tr>
            <th>Total Cost (CAD)</th>
            <th class="money">$6,725,875.21</th>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="budget-note">
      Above roll-up pairs the construction base with remote premium & contingency, then adds design and taxes to give a
      <strong>whole-of-project</strong> planning figure.
    </div>
  </div>

  <!-- Life Cycle snapshot -->
  <div class="box">
    <h2>Lifecycle Snapshot — Cable-Stayed</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th class="num">Value</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Expected Life Cycle (years)</td><td class="num">75–100</td></tr>
          <tr><td>Approx. Annual Maintenance Cost (%)</td><td class="num">0.4%</td></tr>
          <tr><td>Approx. Annual Maintenance Cost (CAD)</td><td class="money">$26,903.50</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Cable-Stayed Design Fee Breakdown (detail) -->
  <div class="box">
    <h2>Design Fee Breakdown — Cable-Stayed (towers + stays)</h2>

    <div class="table-wrap" style="margin-bottom:.75rem;">
      <table>
        <thead>
          <tr>
            <th class="w-240">Role</th>
            <th class="num">Hours</th>
            <th class="num">Rate</th>
            <th class="money">Cost</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Project Manager (E5)</td><td class="num">80</td><td class="num">$299.00</td><td class="money">$23,920.00</td></tr>
          <tr><td>Senior Engineers (E4)</td><td class="num">160</td><td class="num">$274.00</td><td class="money">$43,840.00</td></tr>
          <tr><td>Project Engineers (E3)</td><td class="num">290</td><td class="num">$219.00</td><td class="money">$63,510.00</td></tr>
          <tr><td>Technologists (T4/T5 avg)</td><td class="num">200</td><td class="num">$216.00</td><td class="money">$43,200.00</td></tr>
          <tr><td>Admin</td><td class="num">50</td><td class="num">$80.00</td><td class="money">$4,000.00</td></tr>
          <tr>
            <th>Subtotal (fees)</th><th class="num">780</th><th class="num">—</th><th class="money">$178,470.00</th>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="table-wrap" style="margin-bottom:.75rem;">
      <table>
        <thead>
          <tr>
            <th>Disbursement Type</th>
            <th class="num">Estimated Cost</th>
            <th class="num">Markup</th>
            <th class="money">To Client</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Normal disbursements (8%)</td><td class="num">—</td><td class="num">—</td><td class="money">$14,277.60</td></tr>
          <tr><td>Project-Specific Disbursements</td><td class="num">$50,000.00</td><td class="num">10.00%</td><td class="money">$55,000.00</td></tr>
          <tr><td>Subconsultants (Geotech + Wind/Seismic)</td><td class="num">$120,000.00</td><td class="num">5.00%</td><td class="money">$126,000.00</td></tr>
          <tr><td>Subcontractors (Site prep, traffic, drilling)</td><td class="num">$50,000.00</td><td class="num">10.00%</td><td class="money">$55,000.00</td></tr>
          <tr>
            <th colspan="3">Subtotal (fees + disbursements)</th>
            <th class="money">$428,747.60</th>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="w-220">Tax Type</th>
            <th>Applied on</th>
            <th class="num">Rate</th>
            <th class="money">Cost</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>GST</td><td>Fees + disbursements</td><td class="num">5.00%</td><td class="money">$21,437.38</td></tr>
          <tr><td>PST</td><td>Software + Goods</td><td class="num">7.00%</td><td class="money">$10,000.00</td></tr>
          <tr>
            <th colspan="3">Total design fee</th>
            <th class="money">$460,184.98</th>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="budget-note" style="margin-top:.75rem;">
      Why higher than an arch: tower design, stay-cable forces, damping/aero serviceability, and staged construction.
    </div>
  </div>
</section>

<script>
(function(){
  const fmt = v => v.toLocaleString('en-CA',{style:'currency',currency:'CAD'});
  const table = document.getElementById('phase-table');

  let c=0,p=0,d=0,grand=0;

  // Walk cost rows, fill cells and compute
  table.querySelectorAll('tr[data-row]').forEach(tr=>{
    const tds = tr.querySelectorAll('[data-v]');
    const vC = Number(tds[0].dataset.v||0);
    const vP = Number(tds[1].dataset.v||0);
    const vD = Number(tds[2].dataset.v||0);

    tds[0].textContent = fmt(vC);
    tds[1].textContent = fmt(vP);
    tds[2].textContent = fmt(vD);

    const rowTotal = vC+vP+vD;
    tr.querySelector('.row-sum').textContent = fmt(rowTotal);

    c+=vC; p+=vP; d+=vD; grand+=rowTotal;
  });

  // Totals in table
  document.getElementById('sum-conceptual').textContent = fmt(c);
  document.getElementById('sum-prelim').textContent     = fmt(p);
  document.getElementById('sum-detailed').textContent   = fmt(d);
  document.getElementById('sum-grand').textContent      = fmt(grand);

  // Summary cards
  document.getElementById('card-conceptual').textContent = fmt(c);
  document.getElementById('card-prelim').textContent     = fmt(p);
  document.getElementById('card-detailed').textContent   = fmt(d);
  document.getElementById('card-grand').textContent      = fmt(grand);

  // Share of $5M
  const pct = Math.min(100, (grand / 5_000_000) * 100);
  document.getElementById('share-fill').style.width = pct.toFixed(2) + '%';
  document.getElementById('share-pct').textContent   = pct.toFixed(1) + '%';
})();
</script>
{% endblock %}
