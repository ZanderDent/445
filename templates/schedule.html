{% extends "base.html" %}
{% block title %}TSOLOM BRIDGE PROJECT ‚Äî Timeline{% endblock %}

{% block extra_head %}
  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.49.1"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #00d4b4;
      --secondary: #3b82f6;
      --accent: #f59e0b;
      --bg-dark: #0a0e1c;
      --bg-card: #111827;
      --border: #2a3447;
      --text: #e5e7eb;
      --text-muted: #94a3b8;
    }

    html, body {
      max-width: 100%;
      overflow-x: hidden;
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, var(--bg-dark) 0%, #1e293b 100%);
      touch-action: manipulation;
    }

    .construction-tracker-page {
      max-width: 1400px;
      margin: 1rem auto;
      padding: 0 0.5rem;
    }

    .header {
      margin: 1rem 0;
      padding: 1.25rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px);
      color: var(--text);
      position: relative;
      overflow: hidden;
    }
    .header::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }
    .header h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1.5rem, 2.5vw, 1.8rem);
      font-weight: 700;
      margin: 0;
      letter-spacing: 0.5px;
      color: var(--primary);
      text-shadow: 0 0 8px rgba(0, 212, 180, 0.3);
    }

    .meta {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }
    .meta > div {
      background: rgba(17, 24, 39, 0.7);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.75rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .meta > div:hover {
      transform: translateY(-3px);
      box-shadow: 0 3px 12px rgba(0, 212, 180, 0.2);
    }
    .meta strong { color: var(--primary); font-weight: 600; }

    /* status chip */
    .badge {
      display:inline-block; font-weight:700; letter-spacing:.2px;
      padding: .25rem .6rem; border-radius:.4rem; border:1px solid rgba(255,255,255,.12);
    }

    .box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.25rem;
      color: var(--text);
      margin-bottom: 1rem;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
    }
    h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.25rem;
      margin: 0.25rem 0 1rem;
      color: var(--primary);
      text-shadow: 0 0 6px rgba(0, 212, 180, 0.2);
    }

    .timeline-toolbar {
      display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;
      margin-bottom: 0.75rem; justify-content: center;
    }
    .timeline-toolbar .ctl {
      background: var(--bg-dark);
      color: var(--text);
      border: 1px solid var(--primary);
      border-radius: 0.5rem;
      padding: 0.6rem 1rem;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      min-width: 80px;
      text-align: center;
    }
    .timeline-toolbar .ctl::before {
      content: '';
      position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 212, 180, 0.2), transparent);
      transition: 0.4s;
    }
    .timeline-toolbar .ctl:hover::before,
    .timeline-toolbar .ctl:active::before { left: 100%; }
    .timeline-toolbar .ctl:hover,
    .timeline-toolbar .ctl:active {
      transform: translateY(-2px);
      box-shadow: 0 3px 12px rgba(0, 212, 180, 0.3);
      background: var(--primary);
      color: var(--bg-dark);
    }

    #timeline {
      width: 100%;
      min-height: 360px;
      border-radius: 0.5rem;
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-x pinch-zoom;
    }

    .table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 0.5rem; background: var(--bg-card); padding: 0.25rem; }
    .construction-tracker-page table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 600px; }
    .construction-tracker-page th, .construction-tracker-page td {
      border: 1px solid var(--border); padding: 0.7rem; vertical-align: top; color: var(--text);
    }
    .construction-tracker-page th { background: linear-gradient(180deg, var(--bg-dark) 0%, #162033 100%); color: var(--primary); text-align: left; font-weight: 600; }
    .construction-tracker-page td { background: rgba(17, 24, 39, 0.7); transition: background 0.3s ease; }
    .construction-tracker-page tr:hover td { background: rgba(17, 24, 39, 0.9); }

    .details {
      margin-top: 0.75rem; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem;
      background: rgba(17, 24, 39, 0.7); color: var(--text); box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px); font-size: 0.9rem;
    }

    /* Mobile tweaks */
    @media (max-width: 900px){
      .meta { grid-template-columns: 1fr !important; }
      .timeline-toolbar { flex-direction: column; align-items: stretch; gap: .5rem; }
      .timeline-toolbar .ctl{ width:100%; }
    }
    @media (max-width: 720px) {
      .meta { grid-template-columns: 1fr; }
      .timeline-toolbar .ctl { padding: 0.6rem 0.9rem; font-size: 0.9rem; min-width: 70px; }
      #timeline { min-height: 320px; }
      .construction-tracker-page table { font-size: 0.85rem; min-width: 100%; }
      .construction-tracker-page th, .construction-tracker-page td { padding: 0.5rem; }
      .details { font-size: 0.85rem; }
      h2 { font-size: 1.1rem; }
    }
  </style>
{% endblock %}

{% block content %}
<section class="construction-tracker-page">
  <div class="header">
    <h1 id="proj-title">Tsolum River Bridge ‚Äî Project Schedule</h1>
    <div class="meta" role="list" aria-label="Project facts">
      <div role="listitem"><strong>Project Manager</strong><br><span id="proj-manager">Bridgeworks Collective</span></div>
      <div role="listitem"><strong>Start</strong><br><span id="proj-start"></span></div>
      <div role="listitem"><strong>Target Finish</strong><br><span id="proj-end"></span></div>
      <div role="listitem"><strong>Status</strong><br>
        <span id="status-badge" class="badge">Planned</span>
      </div>
    </div>
  </div>

  <div class="box" style="margin-bottom: 1rem;">
    <h2>Project Timeline</h2>
    <p class="muted" style="margin-top:-.25rem">
      Tip: on mobile, <strong>rotate to landscape</strong> and use the buttons to
      <em>fit</em> the whole schedule or jump to <em>today</em>.<br>Use desktop to <em>scroll sideways</em> and to use more features.<br><br> Tap Gantt Bars to see their details below.
    </p>
    <div class="timeline-toolbar" aria-label="Timeline controls">
      <button id="btn-fit" class="ctl" aria-label="Fit entire schedule">üìê Fit</button>
      <button id="btn-today" class="ctl" aria-label="Go to today">üìÖ Today</button>
    </div>
    <div id="timeline" aria-label="Interactive project timeline"></div>
    <div id="details" class="details" aria-live="polite">Tap a bar to see task details here.</div>
  </div>

  <div class="box">
    <h2>Schedule Details</h2>
    <p class="muted" style="margin-top:-.25rem">
      Full task list with dates, durations, and notes.
    </p>
    <div class="table-wrap">
      <table aria-label="Task schedule table">
        <thead>
          <tr>
            <th>Phase</th>
            <th>Task</th>
            <th>Start</th>
            <th>Finish</th>
            <th>Duration (days)</th>
            <th>Resources</th>
            <th>Schedule</th>
          </tr>
        </thead>
        <tbody id="task-table-body"></tbody>
      </table>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
(async function(){
  // ---- Load schedule (with fallbacks) ----
  async function loadSchedule(){
    const urls=['/api/schedule.json','/schedule.json','{{ url_for("static", filename="schedule.json") }}'];
    for (const u of urls){ try{const r=await fetch(u,{cache:'no-store'}); if(r.ok) return r.json();}catch(e){} }
    return {};
  }
  const sched = await loadSchedule();

  // ---- Header basics ----
  document.getElementById('proj-title').textContent = sched.project || 'Project';
  document.getElementById('proj-manager').textContent = sched.manager || '';
  document.getElementById('proj-start').textContent  = sched.start  || '';
  document.getElementById('proj-end').textContent    = sched.finish || '';

  // ---- Normalize tasks ----
  const toISO = v => v ? new Date(v).toISOString().slice(0,10) : null;
  const addDays=(iso,d)=>{const x=new Date(iso);x.setDate(x.getDate()+d);return x.toISOString().slice(0,10);};

  let tasks = (sched.tasks || []).map(t=>{
    const s=toISO(t.start||t.Start), d=t.duration??t.Duration;
    let e=toISO(t.finish||t.End);
    if(!e&&s&&(d||d===0)) e=addDays(s, Math.max(1,+d)-1);
    const dur=(s&&e)? Math.round((new Date(e)-new Date(s))/86400000)+1 : (isFinite(+d)?+d:null);
    return {
      phase: t.phase||t.Phase||'Ungrouped',
      task:  t.task||t.activityName||t.Task||'',
      start:s, finish:e, duration:dur,
      schedule:t.schedule||'', resources:t.resources||''
    };
  }).filter(t=>t.task&&t.start&&t.finish);

  // Fallback demo if no data
  if(!tasks.length){
    const today=new Date(), iso=d=>d.toISOString().slice(0,10);
    tasks=[
      {phase:'Conceptual Design', task:'Kickoff',            start:iso(today),                          finish:iso(new Date(today.getTime()+2*86400000)), duration:3, resources:'PM',    schedule:'Planned'},
      {phase:'Preliminary Design',task:'Option Development', start:iso(new Date(today.getTime()+3*86400000)), finish:iso(new Date(today.getTime()+9*86400000)), duration:7, resources:'Team',  schedule:'Planned'},
      {phase:'Detailed Design',   task:'Member Design',      start:iso(new Date(today.getTime()+10*86400000)),finish:iso(new Date(today.getTime()+18*86400000)),duration:9, resources:'Struct',schedule:'Planned'}
    ];
    document.getElementById('details').innerHTML = '<em>No schedule.json found ‚Äî showing sample timeline.</em>';
  }

  // ---- Fill table (we‚Äôll overwrite the "Schedule" cell automatically below) ----
  const tbody=document.getElementById('task-table-body');
  tasks.forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.phase}</td><td>${t.task}</td><td>${t.start}</td><td>${t.finish}</td><td>${t.duration??''}</td><td>${t.resources}</td><td class="auto-status">‚Äî</td>`;
    tbody.appendChild(tr);
  });

  // ---- Chart data ----
  const phaseColor = {
    'Conceptual Design': '#00d4b4',
    'Preliminary Design': '#22c55e',
    'Detailed Design': '#14b8a6',
    'Ungrouped': '#3b82f6'
  };
  const points = tasks.map(t=>({
    x: t.task,
    y: [ new Date(t.start).getTime(), new Date(t.finish).getTime() ],
    fillColor: phaseColor[t.phase] || '#3b82f6',
    meta: t
  }));

  const allStarts=points.map(p=>p.y[0]), allEnds=points.map(p=>p.y[1]);
  const minX=Math.min(...allStarts), maxX=Math.max(...allEnds), PAD=2*24*3600*1000;

  // y-axis width sizing (avoid clipping long labels)
  const isMobile = window.matchMedia('(max-width:720px)').matches;
  function computeYAxisWidthPx(labels, fontPx, minPx, capPx){
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.font = `${fontPx}px Roboto, sans-serif`;
    let max = 0; for (const s of labels) { max = Math.max(max, ctx.measureText(String(s||'')).width); }
    return Math.min(Math.max(Math.ceil(max + 16), minPx), capPx);
  }
  const yAxisWidth = computeYAxisWidthPx(tasks.map(t=>t.task), isMobile?11:12, isMobile?120:160, 400);
  const chartHeight = Math.max(isMobile ? 320 : 480, points.length * (isMobile?36:40) + 100);

  const options={
    chart:{
      type:'rangeBar',
      height:chartHeight,
      background:'transparent',
      foreColor: '#e5e7eb',
      toolbar:{ show:true, tools:{download:false,selection:true,zoom:true,zoomin:true,zoomout:true,pan:true,reset:true}, autoSelected:'pan' },
      animations:{ enabled:true, easing:'easeinout', speed:500, animateGradually:{enabled:true,delay:100}, dynamicAnimation:{enabled:true,speed:300} },
      events:{
        dataPointSelection:function(event,ctx,config){
          const dp = ctx.w.config.series[0].data[config.dataPointIndex];
          const d  = dp.meta || {};
          document.getElementById('details').innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.5rem;font-size:0.9rem;">
              <div><strong style="color:var(--primary)">Task</strong><br>${d.task||'‚Äî'}</div>
              <div><strong style="color:var(--primary)">Phase</strong><br>${d.phase||'‚Äî'}</div>
              <div><strong style="color:var(--primary)">Start</strong><br>${d.start||'‚Äî'}</div>
              <div><strong style="color:var(--primary)">Finish</strong><br>${d.finish||'‚Äî'}</div>
              <div><strong style="color:var(--primary)">Duration</strong><br>${d.duration??'‚Äî'} days</div>
              <div><strong style="color:var(--primary)">Resources</strong><br>${d.resources||'‚Äî'}</div>
              <div style="grid-column:1/-1;"><strong style="color:var(--primary)">Schedule</strong><br>${computeRowStatus(d)}</div>
            </div>`;
        }
      },
      zoom:{enabled:true, type:'x', autoScaleYaxis:false}
    },
    series:[{ name:'Timeline', data: points }],
    legend:{ show:false },
    plotOptions:{ bar:{ horizontal:true, barHeight:isMobile?'70%':'60%', rangeBarGroupRows:false, borderRadius:6, colors:{ ranges:[] } } },
    xaxis:{
      type:'datetime', min:minX-PAD, max:maxX+PAD,
      labels:{ datetimeUTC:false, style:{colors:'#e5e7eb', fontFamily:'Roboto', fontSize:isMobile?'11px':'12px'} },
      axisTicks:{ color: '#2a3447' }, axisBorder:{ color: '#2a3447' }
    },
    yaxis: {
      labels: {
        maxWidth: yAxisWidth,
        formatter: function (val) { return val; },
        style: { colors:'#e5e7eb', fontSize:isMobile?'11px':'12px', fontFamily:'Roboto, sans-serif' }
      }
    },
    grid:{ borderColor:'#2a3447', strokeDashArray:4 },
    dataLabels:{
      enabled:true,
      formatter:(val,{dataPointIndex,w})=>{
        const meta=w.config.series[0].data[dataPointIndex].meta;
        return meta && meta.duration ? meta.duration+'d' : '';
      },
      style:{ colors:['#0a0e1c'], fontWeight:700, fontFamily:'Roboto', fontSize:isMobile?'10px':'11px' },
      background:{ enabled:true, borderRadius:4, opacity:0.9, foreColor:'#e5e7eb' }
    },
    tooltip:{
      theme:'dark',
      x:{ format:'yyyy-MM-dd' },
      y:{ formatter:(val,opts)=>{ 
        const [s,e]=opts.w.config.series[0].data[opts.dataPointIndex].y;
        const d=opts.w.config.series[0].data[opts.dataPointIndex].meta||{};
        const fmt=x=>new Date(x).toISOString().slice(0,10);
        return `${fmt(s)} ‚Üí ${fmt(e)} (${d.duration??'‚Äî'}d)`; 
      } }
    },
    fill:{ type:'gradient', gradient:{ shade:'dark', shadeIntensity:0.3, inverseColors:false, opacityFrom:0.95, opacityTo:0.85, stops:[0,100], gradientToColors:[ '#22c55e' ] } },
    states:{ hover:{ filter:{ type:'lighten', value:0.05 } }, active:{ filter:{ type:'none' } } },
    annotations:{ xaxis:[] }
  };

  const el=document.getElementById('timeline');
  const chart=new ApexCharts(el, options);
  await chart.render();

  // ---- Controls ----
  document.getElementById('btn-fit').addEventListener('click', (e)=>{
    e.preventDefault();
    chart.updateOptions({ xaxis:{ min:minX-PAD, max:maxX+PAD }, annotations:{ xaxis:[] } }, true, true);
  }, { passive: false });

  document.getElementById('btn-today').addEventListener('click', (e)=>{
    e.preventDefault();
    const now=Date.now(), span=(maxX-minX)/4;
    chart.updateOptions({
      xaxis:{ min: now-span, max: now+span },
      annotations:{ xaxis:[{ x:now, strokeDashArray:4, borderColor:'#f59e0b', label:{ text:'Today', style:{ background:'#f59e0b', color:'#0a0e1c', fontFamily:'Roboto' } } }] }
    }, true, true);
  }, { passive: false });

  window.addEventListener('resize', ()=>chart.resize(), { passive: true });

  // ===== Auto Status Logic =====
  const statusBadge = document.getElementById('status-badge');
  const projectStart = sched.start ? new Date(sched.start) : null;
  const projectFinish = sched.finish ? new Date(sched.finish) : null;
  const MS_DAY = 86400000;

  function clamp(n,min,max){ return Math.min(max,Math.max(min,n)); }
  function daysBetween(a,b){ return Math.max(0, Math.round((b - a)/MS_DAY)); }

  function computeProjectStatus(){
    if(!projectStart || !projectFinish || isNaN(projectStart) || isNaN(projectFinish)){
      return { text:'Planned', bg:'#334155', fg:'#e5e7eb' };
    }
    const now = new Date();
    const total = Math.max(1, projectFinish - projectStart);
    const elapsed = clamp(now - projectStart, 0, total);
    const pct = Math.round((elapsed/total)*100);

    if (now < projectStart){
      const daysToStart = daysBetween(now, projectStart);
      return { text:`Planned ‚Äî starts in ${daysToStart}d`, bg:'#1e293b', fg:'#e5e7eb' };
    } else if (now > projectFinish){
      return { text:'Complete (per plan)', bg:'#16a34a', fg:'#041014' };
    } else {
      return { text:`In Progress ‚Äî ${pct}%`, bg:'#22c55e', fg:'#041014' };
    }
  }

  function paintBadge(s){
    statusBadge.textContent = s.text;
    statusBadge.style.background = s.bg;
    statusBadge.style.color = s.fg;
    statusBadge.style.borderColor = 'rgba(255,255,255,.12)';
  }

  // NEW: no ‚ÄúLate‚Äù‚Äîjust Done / In Progress / Upcoming
  function computeRowStatus(t){
    const now = new Date();
    const s = new Date(t.start), e = new Date(t.finish);
    if (now < s) return 'Upcoming';
    if (now > e) return 'Done';
    return 'In Progress';
  }

  function paintRowStatuses(){
    const rows = document.querySelectorAll('#task-table-body tr');
    rows.forEach((tr,i)=>{
      const cell = tr.querySelector('.auto-status');
      if(!cell) return;
      const v = computeRowStatus(tasks[i]);
      cell.textContent = v;
      // Color cues: Done = green, In Progress = teal/blue, Upcoming = slate
      if (v==='Done'){
        cell.style.color = '#86efac';   // green-300
      } else if (v==='In Progress'){
        cell.style.color = '#7dd3fc';   // sky-300
      } else {
        cell.style.color = '#a3aed0';   // slate-ish
      }
      cell.style.fontWeight = '700';
    });
  }

  function tickStatus(){
    paintBadge(computeProjectStatus());
    paintRowStatuses();
  }

  // initial + refresh every 60s (handles midnight rollovers)
  tickStatus();
  setInterval(tickStatus, 60000);

})();
</script>
{% endblock %}
